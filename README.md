## TL;DR
- CHARM is specifically tailored for GeMM on AIE. It require non-trivial efforts to adapt it for more generic applications 


## CHARM CodeGen Templates
- Complex and tailored to GeMM: templates in bash script + Jinja2 to generate ADF code for AIEs, HLS code for PL, and host code using XRT APIs.

```bash
# Shell
mkdir -p ${dir_name}/aie
if [ ${kernel_type} == 0 ]
then
echo \
"#include "'"aie_graph.h"'"
using namespace adf;

PLIO* in0 = new PLIO("'"DataIn0"'", adf::plio_32_bits, \"../${din_name}input0.txt\",1000);

.....

">> ./${dir_name}/aie/mm_top.cpp;
```

- C++ Jinja template

```cpp
void compute(axis_stream_A& dataA_out, axis_stream_B& dataB_out, axis_stream_C& dataC_in,
             {% set num_lhs=A*NUM_TXL*(B//PACK_IN) -%}
             {% set div_lhs=num_lhs//4 -%}
             {% set left_lhs=num_lhs%4 -%}
             {% for i in range(div_lhs) -%}
             axis_stream& txA{{i*4}}, axis_stream& txA{{i*4+1}}, axis_stream& txA{{i*4+2}}, axis_stream& txA{{i*4+3}},
             {% endfor-%}
             {% for i in range(left_lhs)%} axis_stream& txA{{i+div_lhs*4}},{% endfor-%}
```

## Errors
- 8K x 8K MatMul routing error on VCK5000. Even 1K by 1K is too large. Was able to do 512 x 512 to avoid routing error.

```bash
INFO: [aiecompiler 35-3211] AIE Router finished creating Pin Mapper.
INFO: [aiecompiler 35-3212] AIE Router Pin Mapper creation cpu time 0.120000 wall time 0.110000
INFO: [aiecompiler 35-3206] AIE Router found a column with over 80 percent horizontal resource utilization
Column[6] : East : 0/3600 West : 3200/3600

ERROR: [aiecompiler 35-3174] AIE Router detected routing bottleneck on col: 10 row: 0.
(WARNING:8, CRITICAL-WARNING:0, ERROR:1)
/opt/xilinx/Vitis/2022.1/aietools/bin/aieir_be: line 98: kill: (-478695) - No such process
Compilation Failed
```

- Using the Makefile generated by CHARM, the linking stage failed with the following error. 

```bash
# in linking stage
v++ -l -t hw --platform /opt/xilinx/platforms/xilinx_vck5000_gen3x16_xdma_1_202120_1/xilinx_vck5000_gen3x16_xdma_1_202120_1.xpfm --save-temps --optimize 2 --hls.jobs 8 --config ./conn.cfg  --kernel_frequency 230 --temp_dir ./build_dir.hw.xilinx_vck5000_gen3x16_xdma_1_202120_1 --vivado.synth.jobs 8 --vivado.impl.jobs 8 -o build_dir.hw.xilinx_vck5000_gen3x16_xdma_1_202120_1/xilinx_vck5000_gen3x16_xdma_1_202120_1hw.xclbin ./_x.hw.xilinx_vck5000_gen3x16_xdma_1_202120_1/dma0.xo  libadf.a
...

ERROR: [v++ 82-4222] Output file type of .xsa is required. A different output file type has been specified: build_dir.hw.xilinx_vck5000_gen3x16_xdma_1_202120_1/xilinx_vck5000_gen3x16_xdma_1_202120_1hw.xclbin
INFO: [v++ 60-1653] Closing dispatch client.
make: *** [Makefile:111: build_dir.hw.xilinx_vck5000_gen3x16_xdma_1_202120_1/xilinx_vck5000_gen3x16_xdma_1_202120_1hw.xclbin] Error 1
```